---
title: "Problem Set 2"
author: "Michael Fryer"
date: "`r Sys.Date()`"
output:
 pdf_document:
   number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rethinking)
library(dagitty)
```

# Multiple Regression & Causal Models
The `foxes` dataset contains data on urban fox populations.

```{r}
# First, load the foxes dataset
data(foxes)
d <- foxes
# You must set random seed to 390
rseed <- 390
set.seed(rseed)
```
```{r, echo=FALSE, eval=FALSE}
# Inspect variables in `foxes`
str(d)
```

Consider the following hypothesized causal relationship between **territory size** and **body weight** in foxes.

```{r, fig.align="center", echo=FALSE}
fox_dag <- dagitty("dag {
  A -> F
  A -> W
  F -> W
}")
coordinates(fox_dag) <- list(x=c(A=0, F=-0.5, W=0.5), y=c(A=0, F=1, W=1))
drawdag(fox_dag, xlim=c(-1, 1), ylim=c(-1, 1), shapes=c(A="c", F="c"))
```

where $A$, $F$ and $W$ represent random variables `area` (territory size), `avgfood`, and `weight`, respectively.

If this DAG correctly describes the causal relationships, it makes specific predictions about what we should observe in the data. Your task is to test whether the observed patterns match these predictions.

- Territory size (A) has a **direct** effect on weight $(W): A \rightarrow W$
- Food availability (F) has a **direct** effect on weight $(W): F \rightarrow W$
- Territory size (A) has an **indirect** effect on weight $(W)$ through food $(F): A \rightarrow F \rightarrow W$

## Standardize the Values

```{r}
d$A <- standardize(d$area)
d$F <- standardize(d$avgfood)
d$W <- standardize(d$weight)
```

## Part A

**a)** According to the DAG, territory size effects weight through two paths:

- Direct path: $A \rightarrow W$
- Indirect path: $A \rightarrow F \rightarrow W$

If we regress weight on territory size without including food, the coefficient should capture both pathways, the "total association" between $A$ and $W$. Construct a linear regression (`m1a`) using `quap`. Urban foxes in this population have an average weight of 5kg. Use prior predictive simulation to assess the implications of your priors. Standardize the prediction variable.

### Prior Predictive Simulation

```{r}
N <- 100
# As our data is standardized, we would expect our intercept, a, to be very
#   close to 0
a <- rnorm(N, 0, 0.2)
# b represents the rate of change between our observed and unobserved variables.
#   A value of 1 implies that for every one sd of change in our observed var.
#   there is 1 sd of change in our unobserved variables. We will choose a sd of
#   0.5 since that means we expect most of these slopes to be in -1 < b < 1
b <- rnorm(N, 0, 0.5)
```
```{r, echo=FALSE}
# Plot the prior prediction
plot(NULL,
     xlim=range(d$A), ylim=c(-2.5, 2.5),
     xlab="Area sq-km (std)", ylab="Weight (std)"
)
mtext("Prior Prediction")
# Graph all the lines
for (i in 1:N) 
  curve(
    a[i] + b[i]*x,
    from=min(d$A),
    to=max(d$A),
    col=col.alpha("black", 0.2),
    add=TRUE
  )
```

### Linear Regression

```{r}
mA <- quap(
  alist(
    W ~ dnorm(mu, sigma),
    # data is standardized so no need to subtract xbar
    mu <- a + bA*A,
    # Priors from earlier
    a ~ dnorm(0, 0.2),
    bA ~ dnorm(0, 0.5),
    sigma ~ dexp(1)
  ),
  data=d
)
```
```{r, echo=FALSE}
precis(mA)
```

### Simulate the Priors

```{r}
set.seed(rseed)
prior <- extract.prior(mA)
mu <- link(mA, post=prior, data=list(A=c(-2, 2)))
```
```{r, echo=FALSE}
plot(NULL, 
     xlim=c(-2, 2), ylim=c(-2, 2),
     xlab="Area sq-km (std)", ylab="Weight (std)"
)
mtext("Prior Simulation")
for (i in 1:N) lines(c(-2, 2), mu[i,], col=col.alpha("black", 0.2))
```

### Posterior Predictions

```{r}
A.seq <- seq(from=-3, to=3, length.out=N)
mu <- link(mA, data=list(A=A.seq))
mu.mean <- apply(mu, 2, mean)
mu.PI <- apply(mu, 2, PI)
```
```{r, echo=FALSE}
# Plot raw data
plot(W ~ A, data=d, col=rangi2, xlab="Area sq-km (std)", ylab="Weight (std)")
mtext("Posterior Prediction")
# Plot MAP line
lines(A.seq, mu.mean, lwd=2)
# Plot HDPI region for line
shade(mu.PI, A.seq)
```

**Question:** What association do you observe? What does your analysis suggest about how territory size relates to weight?

\textit{We observe a MAP with a slope of roughly 0. This tells us that there is essentially no relation between territory size and weight.}

## Part B

**b)** Regress weight on food availability. That is, construct a `quap` linear regression (`m1b`) to estimate the association of food availability and fox weight. _Before fitting the model_, standardize both `avgfood` and `weight` to have mean 0 and standard deviation 1.

**Hint:** \textit{With standardized variables, regression slopes represent standardized effect sizes. A slope of 1.0 would indicate a perfect positive relationship, while slopes >2 would be implausibly large for most ecological relationships.}

Use prior predictive simulation to assess the implication of your priors. Write 1-2 sentences to justify your priors.

### Prior Predictive Simulation

```{r}
N <- 100
# As our data is standardized, we would expect our intercept, a, to be very
#   close to 0
a <- rnorm(N, 0, 0.2)
# b represents the rate of change between our observed and unobserved variables.
#   A value of 1 implies that for every one sd of change in our observed var.
#   there is 1 sd of change in our unobserved variables. We will choose a sd of
#   0.5 since that means we expect most of these slopes to be in -1 < b < 1
b <- rnorm(N, 0, 0.5)
```
```{r, echo=FALSE}
# Plot the prior prediction
plot(NULL,
     xlim=range(d$F), ylim=c(-2.5, 2.5),
     xlab="Food Availability (std)", ylab="Weight (std)"
)
mtext("Prior Prediction")
# Graph all the lines
for (i in 1:N) 
  curve(
    a[i] + b[i]*x,
    from=min(d$F),
    to=max(d$F),
    col=col.alpha("black", 0.2),
    add=TRUE
  )
```

### Linear Regression

```{r}
mF <- quap(
  alist(
    W ~ dnorm(mu, sigma),
    # data is standardized so no need to subtract xbar
    mu <- a + bF*F,
    # Priors from earlier
    a ~ dnorm(0, 0.2),
    bF ~ dnorm(0, 0.5),
    sigma ~ dexp(1)
  ),
  data=d
)
```
```{r, echo=FALSE}
precis(mF)
```

### Simulate the Priors

```{r}
set.seed(rseed)
prior <- extract.prior(mF)
mu <- link(mF, post=prior, data=list(F=c(-2, 2)))
```
```{r, echo=FALSE}
plot(NULL, 
     xlim=c(-2, 2), ylim=c(-2, 2),
     xlab="Food Availability (std)", ylab="Weight (std)"
)
mtext("Prior Simulation")
for (i in 1:N) lines(c(-2, 2), mu[i,], col=col.alpha("black", 0.2))
```

### Posterior Predictions

```{r}
F.seq <- seq(from=-3, to=3, length.out=N)
mu <- link(mF, data=list(F=F.seq))
mu.mean <- apply(mu, 2, mean)
mu.PI <- apply(mu, 2, PI)
```
```{r, echo=FALSE}
# Plot raw data
plot(W ~ F, data=d, col=rangi2,
     xlab="Food Availability (std)", ylab="Weight (std)"
)
mtext("Posterior Prediction")
# Plot MAP line
lines(F.seq, mu.mean, lwd=2)
# Plot HDPI region for line
shade(mu.PI, F.seq)
```

## Part C

**c)** Now regress weight on _both_ territory size and food availability Construct a `quap` model (`m1c`) that includes both predictors. Use the standardized variables. Explain your findings with 3-4 sentences and appropriate plots.

### Prior Predictive Simulation

```{r}
N <- 100
# As our data is standardized, we would expect our intercept, a, to be very
#   close to 0
a <- rnorm(N, 0, 0.2)
# bA from above
bA <- rnorm(N, 0, 0.5)
# bF from above
bF <- rnorm(N, 0, 0.5)
```

### Linear Regression

```{r}
mAF <- quap(
  alist(
    W ~ dnorm(mu, sigma),
    # data is standardized so no need to subtract xbar
    mu <- a + bA*A + bF*F,
    # Priors from earlier
    a ~ dnorm(0, 0.2),
    bA ~ dnorm(0, 0.5),
    bF ~ dnorm(0, 0.5),
    sigma ~ dexp(1)
  ),
  data=d
)
```
```{r, echo=FALSE}
precis(mAF)
```
```{r, echo=FALSE}
plot(coeftab(mA, mF, mAF), par=c("bA", "bF"))
```


# AI Declaration
