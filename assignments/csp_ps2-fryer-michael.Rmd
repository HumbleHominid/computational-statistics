---
title: "Problem Set 2"
author: "Michael Fryer"
date: "Collaborators: Florian Robrecht, Janin Janokawski"
output:
 pdf_document:
   number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rethinking)
library(dagitty)
```

For this assignment, I collaborated with Florian and Janin by discussion our independent solutions.

# Multiple Regression & Causal Models
The `foxes` dataset contains data on urban fox populations.

```{r}
# First, load the foxes dataset
data(foxes)
d <- foxes
# You must set random seed to 390
rseed <- 390
set.seed(rseed)
```
```{r, echo=FALSE, eval=FALSE}
# Inspect variables in `foxes`
str(d)
```

Consider the following hypothesized causal relationship between **territory size** and **body weight** in foxes.

```{r, fig.align="center", echo=FALSE}
fox_dag <- dagitty("dag {
  A -> F
  A -> W
  F -> W
}")
coordinates(fox_dag) <- list(x=c(A=0, F=-0.5, W=0.5), y=c(A=0, F=1, W=1))
drawdag(fox_dag, xlim=c(-1, 1), ylim=c(-1, 1))
```

where $A$, $F$ and $W$ represent random variables `area` (territory size), `avgfood`, and `weight`, respectively.

If this DAG correctly describes the causal relationships, it makes specific predictions about what we should observe in the data. Your task is to test whether the observed patterns match these predictions.

- Territory size (A) has a **direct** effect on weight $(W): A \rightarrow W$
- Food availability (F) has a **direct** effect on weight $(W): F \rightarrow W$
- Territory size (A) has an **indirect** effect on weight $(W)$ through food $(F): A \rightarrow F \rightarrow W$

## Standardize the Values

```{r}
d$A <- standardize(d$area)
d$F <- standardize(d$avgfood)
d$W <- standardize(d$weight)
```

## Part A

**a)** According to the DAG, territory size effects weight through two paths:

- Direct path: $A \rightarrow W$
- Indirect path: $A \rightarrow F \rightarrow W$

If we regress weight on territory size without including food, the coefficient should capture both pathways, the "total association" between $A$ and $W$. Construct a linear regression (`m1a`) using `quap`. Urban foxes in this population have an average weight of 5kg. Use prior predictive simulation to assess the implications of your priors. Standardize the prediction variable.

\textit{Based on above, I am assuming that only the predictor variable, \textbf{area}, should be standardized for this model.}

### Prior Predictive Simulation

\textbf{A note on priors:} \textit{For this model with a standardized predictor, the value of $a$ represents our expected weight when the predictor $A = 0$. Since we are told weigh 5kg on average in this population, we will create a normal distribution with $\mu = 5$ and $\sigma = 0.75$ which represents 15\% of the mean. The value of $b$ represents the rate of change between our predictor and outcome variables. A value of 1 implies that for every 1 standard deviation of change in our prediction variable, there is 1kg of change in our outcome variable. For this model, I will be using a normal distribution with $\mu = 0$ and $\sigma = 0.5$.}

```{r}
N <- 100
a <- rnorm(N, 5, 0.75)
b <- rnorm(N, 0, 0.5)
```
```{r, echo=FALSE}
# Plot the prior prediction
plot(NULL,
     xlim=range(d$A), ylim=c(0, 10),
     xlab="Area sq-km (std)", ylab="Weight kg"
)
mtext("Prior Prediction")
# Graph all the lines
for (i in 1:N) 
  curve(
    # No need to subtract xbar as our predictor is standardized
    a[i] + b[i]*x,
    from=min(d$A),
    to=max(d$A),
    col=col.alpha("black", 0.2),
    add=TRUE
  )
```

### Linear Regression

```{r}
m <- quap(
  alist(
    weight ~ dnorm(mu, sigma),
    # No need to subtract mean as our predictor is standardized
    mu <- a + b*A,
    # Priors from earlier
    a ~ dnorm(5, 0.75),
    b ~ dnorm(0, 0.5),
    sigma ~ dexp(1)
  ),
  data=d
)
```
```{r, echo=FALSE}
precis(m)
```

### Posterior Predictions

```{r}
set.seed(rseed)
post <- extract.samples(m, n=20)
```
```{r, echo=FALSE}
plot <- plot(d$A, d$weight,
  xlim=range(d$A), ylim=range(d$weight),
  xlab="Area sq-km (std)", ylab="Weight kg",
  col=rangi2
)
mtext("Posterior Regressor Samples")
for (i in 1:nrow(post)) {
  curve(post$a[i] + post$b[i]*x, col=col.alpha("black", 0.3), add=TRUE)
}
```

```{r}
A.seq <- seq(from=-3, to=3, length.out=N)
mu <- link(m, data=list(A=A.seq))
mu.mean <- apply(mu, 2, mean)
mu.PI <- apply(mu, 2, PI)
sim.weight <- sim(m, data=list(A=A.seq))
weight.PI <- apply(sim.weight, 2, PI, prob=0.89)
```
```{r, echo=FALSE}
# Plot raw data
plot(weight ~ A, data=d, col=rangi2, xlab="Area sq-km (std)", ylab="Weight kg")
mtext("Posterior Prediction")
# Plot MAP line
lines(A.seq, mu.mean, lwd=2)
# Plot HDPI region for line
shade(mu.PI, A.seq)
# Plot PI region for simulated weights
shade(weight.PI, A.seq)
```

**Question:** What association do you observe? What does your analysis suggest about how territory size relates to weight?

\textit{With $\mu = 0.02$ and $\sigma = 0.11$ we observe neither a strong nor precise relationship between these two variables, illustrated in the figure above. While the slope is positive, this analysis tells us that territory size gives very little information about weight.}

## Part B

**b)** Regress weight on food availability. That is, construct a `quap` linear regression (`m1b`) to estimate the association of food availability and fox weight. _Before fitting the model_, standardize both `avgfood` and `weight` to have mean 0 and standard deviation 1.

**Hint:** \textit{With standardized variables, regression slopes represent standardized effect sizes. A slope of 1.0 would indicate a perfect positive relationship, while slopes >2 would be implausibly large for most ecological relationships.}

Use prior predictive simulation to assess the implication of your priors. Write 1-2 sentences to justify your priors.

\textbf{A note on priors:} \textit{Since both our predictor and outcome variables are standardized, we will simulate priors with $\mu = 0$ and a small standard deviation. For our intercept prior, $a$, we will use $\sigma = 0.2$ as we expect our data to be tight around the mean. For our slope prior, $b$, we will use $\sigma = 0.5$ as we expect most slopes to be in $-1 < b < 1$.}

### Prior Predictive Simulation

```{r}
N <- 100
a <- rnorm(N, 0, 0.2)
b <- rnorm(N, 0, 0.5)
```
```{r, echo=FALSE}
# Plot the prior prediction
plot(NULL,
     xlim=range(d$F), ylim=c(-2.5, 2.5),
     xlab="Food Availability (std)", ylab="Weight kg (std)"
)
mtext("Prior Prediction")
# Graph all the lines
for (i in 1:N) 
  curve(
    # No need to subtract xbar as our predictor is standardized
    a[i] + b[i]*x,
    from=min(d$F),
    to=max(d$F),
    col=col.alpha("black", 0.2),
    add=TRUE
  )
```

### Linear Regression

```{r}
mF <- quap(
  alist(
    W ~ dnorm(mu, sigma),
    # No need to subtract mean as our predictor is standardized
    mu <- a + bF*F,
    # Priors from earlier
    a ~ dnorm(0, 0.2),
    bF ~ dnorm(0, 0.5),
    sigma ~ dexp(1)
  ),
  data=d
)
```
```{r, echo=FALSE}
precis(mF)
```


### Posterior Predictions

```{r}
set.seed(rseed)
post <- extract.samples(mF, n=20)
```
```{r, echo=FALSE}
plot <- plot(d$A, d$W,
  xlim=range(d$A), ylim=range(d$W),
  xlab="Araea sq-km (std)", ylab="Weight kg (std)",
  col=rangi2
)
mtext("Posterior Regressor Samples")
for (i in 1:nrow(post)) {
  curve(post$a[i] + post$b[i]*x, col=col.alpha("black", 0.3), add=TRUE)
}
```

```{r}
F.seq <- seq(from=-3, to=3, length.out=N)
mu <- link(mF, data=list(F=F.seq))
mu.mean <- apply(mu, 2, mean)
mu.PI <- apply(mu, 2, PI)
sim.W <- sim(mF, data=list(F=F.seq))
W.PI <- apply(sim.W, 2, PI, prob=0.89)
```
```{r, echo=FALSE}
# Plot raw data
plot(W ~ F, data=d, col=rangi2,
     xlab="Food Availability (std)", ylab="Weight kg (std)"
)
mtext("Posterior Prediction")
# Plot MAP line
lines(F.seq, mu.mean, lwd=2)
# Plot HDPI region for line
shade(mu.PI, F.seq)
# Plot PI region for simulated W's
shade(W.PI, F.seq)
```

\textit{As with \textbf{a)}, we observe neither a strong nor precise association with $\mu = -0.02$ and $\sigma = 0.09$. This implies food availability gives little information about weight. It is notable that food availability appears to have a negative impact on weight whereas territory size has a positive impact.}

## Part C

**c)** Now regress weight on _both_ territory size and food availability Construct a `quap` model (`m1c`) that includes both predictors. Use the standardized variables. Explain your findings with 3-4 sentences and appropriate plots.

\textit{In the below analysis, I will standardize both the predictor variables and the outcome variable. This is done so we can accurately compare the models to one another later on.}

### Linear Regression

```{r}
# Area predictor with standardized weight
mA <- quap(
  alist(
    W ~ dnorm(mu, sigma),
    mu <- a + bA*A,
    a ~ dnorm(0, 0.2),
    bA ~ dnorm(0, 0.5),
    sigma ~ dexp(1)
  ),
  data=d
)
# Food availability predictor reused from above
# Both predictors with standardized weight
mAF <- quap(
  alist(
    W ~ dnorm(mu, sigma),
    mu <- a + bA*A + bF*F,
    a ~ dnorm(0, 0.2),
    bA ~ dnorm(0, 0.5),
    bF ~ dnorm(0, 0.5),
    sigma ~ dexp(1)
  ),
  data=d
)
```

```{r, echo=FALSE}
cat("Standardized Area Predictors:")
precis(mA)
cat("Standardized Area and Food Availability Predictors:")
precis(mAF)
```
```{r, echo=FALSE}
plot(coeftab(mA, mF, mAF), par=c("bA", "bF"), xlab="Estimate")
mtext("Posterior Coefficient Table")
```

\textit{In the above figure, we can see that $A$ and $F$ are each more correlated with $W$ in the combined model, $mAF$, than in either of the bivariate models $mA$ and $mF$. However, we also note that the uncertainty, standard deviation, has increased drastically. Observing results like this is a strong indicator of a potential masked relationship.}

## Masked Relationship

\textit{Although this is not part of the assignment, I will consider the following relationship for my own edification.}

```{r, fig.align="center", echo=FALSE}
fox_dag <- dagitty("dag {
  U -> A
  U -> F
  A -> W
  F -> W
}")
coordinates(fox_dag) <- list(x=c(U=0, A=-0.25, F=0.25, W=0), y=c(U=0, A=0.5, F=0.5, W=1))
drawdag(fox_dag, xlim=c(-1, 1), ylim=c(-1, 1), shapes=c(U="c"))
```

\textit{From a simple pairs plot, we can see that $A$ and $F$ are positively correlated with one another. The result of this pattern is that the two predictors tend to cancel eachother out.}

```{r, echo=FALSE}
pairs(~W + A + F, d, lower.panel=NULL)
```

### Counterfactuals

\textit{Going of the assumption that the above DAG is accurate, we will simulate breaking the links from $U \rightarrow A$ and $U \rightarrow F$ by producting counterfactual plots wherin one predictor is held at 0.}

```{r}
x.seq <- seq(from=min(d$A) - 0.15, to=max(d$A) + 0.15, length.out=30)
mu <- link(mAF, data=data.frame(A=x.seq, F=0))
mu.mean <- apply(mu, 2, mean)
mu.PI <- apply(mu, 2, PI)
plot(NULL,
     xlim=range(d$A), ylim=range(d$A),
     xlab="Area sq-km (std)", ylab="Weight kg (std)"
)
mtext("Counterfactual holding F = 0")
lines(x.seq, mu.mean, lwd=2)
shade(mu.PI, x.seq)
```

```{r}
x.seq <- seq(from=min(d$F) - 0.15, to=max(d$F) + 0.15, length.out=30)
mu <- link(mAF, data=data.frame(F=x.seq, A=0))
mu.mean <- apply(mu, 2, mean)
mu.PI <- apply(mu, 2, PI)
plot(NULL,
     xlim=range(d$F), ylim=range(d$F),
     xlab="Food Availability (std)", ylab="Weight kg (std)"
)
mtext("Counterfactual holding A = 0")
lines(x.seq, mu.mean, lwd=2)
shade(mu.PI, x.seq)
```

\textit{Although we can't be sure that this DAG wholly represents this data, in fact there are many DAGs that fit this data, we can see that the DAG(U, A, F, W) fits this observed data. That is, there is likely some unobserved $U$ that is a common cause of $M$ and $N$.}

# AI Declaration

AI was not used for this assignment.